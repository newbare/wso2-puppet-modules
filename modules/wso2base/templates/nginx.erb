<%- upstreams = scope.function_hiera(['upstreams']) -%>

<%- upstreams.each do |upstream| -%>
upstream <%= upstream["name"] %>{
      ip_hash;
      <%- upstream["hosts"]["host"].each do |host| -%>
      server <%= host %>;
      <%- end -%>
}
<%- end -%>

<%- servers = scope.function_hiera(['servers']) -%>

<%- servers.each do |server| -%>
server {
      listen <%= server["port"] %>;
      server_name <%= server["name"] %>;

      <%- server["locations"]["location"].each do |location| -%>
      location <%= location["context"] %> {
              proxy_set_header X-Forwarded-Host $host;
              proxy_set_header X-Forwarded-Server $host;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header Host $http_host;
              proxy_read_timeout 5m;
              proxy_send_timeout 5m;
              proxy_pass https://<%= location["proxypass"] %>$request_uri;
        }
      <%- end -%>

      <%- if server["sslstatus"] -%>
      ssl <%= server["sslstatus"] %>;
      ssl_certificate <%= server["sslcertificate"] %>;
      ssl_certificate_key <%= server["sslcertificatekey"] %>;
      <%- end -%>
}
<%- end -%>
